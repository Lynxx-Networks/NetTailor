#!/bin/bash

export DB_USER=$DB_USER
export DB_PASSWORD=$DB_PASSWORD
export DB_HOST=$DB_HOST
export DB_NAME=$DB_NAME
export DB_PORT=$DB_PORT
export USE_CLOUD_STORAGE=$USE_CLOUD_STORAGE
export FULLNAME=${FULLNAME:-'nettailor Admin'}
export USERNAME=${USERNAME:-'pine-admin'}
export EMAIL=${EMAIL:-'admin@nettailor.online'}
export PASSWORD=${PASSWORD:-$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c14 ; echo '')}
export REVERSE_PROXY=$REVERSE_PROXY
export API_URL=$API_URL
export NETTAILOR_PORT=$NETTAILOR_PORT
export PROXY_PROTOCOL=$PROXY_PROTOCOL
export DEBUG_MODE=${DEBUG_MODE:-'False'}

if [[ $FULLNAME == 'nettailor Admin' ]]; then
  echo "Admin User Information:"
  echo "FULLNAME: $FULLNAME"
  echo "USERNAME: $USERNAME"
  echo "EMAIL: $EMAIL"
  echo "PASSWORD: $PASSWORD"
fi
echo "Database Information:"
echo "DB_USER: $DB_USER"
echo "DB_PASSWORD: $DB_PASSWORD"
echo "DB_HOST: $DB_HOST"
echo "DB_NAME: $DB_NAME"
echo "DB_PORT: $DB_PORT"

cat << "EOF"


                                       +--::::-------:::::--=                                       
                                 +:::+%@#--*%@@@@%@@@@@#+:=%@%-:::+                                 
                            #:::#%=+%@@@@@@%#++#=-:@=+*#%@@@@@@#=*@+::-                             
                         -::#%:@@@@%%-*@@%@@@@@@@:+@@@@@%@%@@=+@@@@@*=@=::-                         
                      -::@=#@@@%-%#*#@*-*@@@@@@@@@@@@@@@@@%*-@**+-*=@@@@=##::=                      
                    ::%+#@@@=%%%@+%%@@@@@@@@%%#*+--+**#%%@@@@@@@@+#@%@**@@@=%+::                    
                 =:-@-@@@-@%%#+@@@@=.....#@@@@@%#=+#%@@@@@=.....#@@@@:@%%##@@@-@::+                 
               ::+#%@@%*=@*#@@@=@@..........=@@@@%%@@@@-.........=@%+@@@-@=%-@@@:@::*               
             ::=#%@@=@*%#%@@=---@@+............-@@@%.............%@@---*@@-#=@*%@@-@::%             
            ::@*@@-@%@%@@*=--#@@@@@..........@@+:..-#@%..........@@@@@=---@@@:@%@@@@-#:=            
          #:#=@@*%%%%@@=--=@@-..@@@-.......@%*%###-%+++@#.......%@@@..*@@---*@@-%%+@@#%-:%          
         ::@%@@*%%+@@---%@#..:..@@@@.....=@@%*=#%**##@%%@@.....:@@@@:....%@#--*@@-#%+@@-#:+         
        :==@@+%%%@@=-#@@....:..:@@@@=:..@@%@@%%*%:*--#%@@*@-::.@@@@@.::....:@@=-@@@%%*@@+@::        
       :#-@@=%%*@@=@@-.....:..::@@@@@..@@@%%%@@@@@%*@@@*:-+@%:+@@@@#:.::.:....=@@-@@=%%%@@@::       
      :%=@@%@%@@+=+@%.:.:::::-::#@@@@@@-...........@%@@-..:=#@@@@@@=:::::::::..@@==@@=@@%@@%::      
     :%=@+.:#@@-:#@@@.:::::::::--@@@*...:=@@@#%@#+=-=*@#:..:+*@@@@@-::-:::::::=@@@::%@@-*-+@%:-     
    :*-@@=@#=@::-:@@@*::::-----*@%...:*@@:......@@@@@@%+-::-+#%@@@@---:--::::-@@@@---#+@#@@@%@:-    
   --+@@-@@@@-:--:#@@@:------@%...:-%#.....:-=*+-@+#@@%*===+*%@@@@%-----------@@@:::--%@=@@@@*%:+   
  =:%%@=%:#@@@:--:-@@@*-=-==@..:-:......:-=+#@@%#@%#%@@@@@@@%@@@@@+====------@@@%----=@@@*-+@@=+:@  
  :#=@@@@-@%=@*----#@@@===*@+.::..:---=+*@@@*-...%@=--:.....#@@@@@*+++======+@@@:---:@#-@@@@-@@%:-  
 +:#@@=@*@@-=+@::---@@@%**%@..:..:==+:........:::.@@@@@%=-::...#@@%%*+++====@@@#----@@==*@+@@@@=*:# 
 :*=@%@@#@+===%@-====@@@#%@.....:--:...:::--=++#+-@%....=@@#=-:...-@@%%**++#@@@==-=-@+===@@#@=@@%:= 
 :@@@*@@@@=+=++@*=+++@@@@@-.....--:..:-=+**%@@@%+%@==-:......=#+==-..*@%#**@@@*=+=-@%+++#+@@@#@@==: 
=-+@@+:+@@@*+==+@-*+##@@@#.....--....::........:@@#*@@@++--::.....:-:.-@@%@@@@#*++@@#**%@-@##+=@*%:@
:*=@%@+@@=@#**++%@*##%@@@.....--.....:::::::--::.@:.....-#%+++=-:...-..-@@@@@%##+%@%%%%@@#@@***@@%:*
:@#@*@@@@:@@#*++*@@%%%@@.....-......:::---*+++*=@#++=-:........=-:......=@@@%%##+@@@@@%*-:@@=@+@@#:-
:@%@+%#@@=@@@%#**+@@@@@=...........:::--=+@@%#=@@@@@@*++=---::..--:......-@@@%%*@..==+*%@@@@=%*@@*-:
:@@@=%*@@+@@@@%%%%*@@@#...........:::--=+@@@@@@@:.....+@@#+=-::...-:......-@@@#@%@#--+%@@@%@+%#@@*-:
:@%@+%#@@::+@@@@%@@@@@..........:::----+@@@@@%%@===::......--::....:-......-@@@@@%%#%%@@:-*@+@*@@*-:
:@*@*@%@-@:%%@@@@@@@@.........:::-----*%@@@@###@+*@*++=--:::-::.............:@@@@%#%@@@-@.%@=@+@@#:-
:*=@@@@@@%+@@@@@@@@@......:.:::-----=+*@@@@@#**#@#*@@@@%=---::::..............@@@@@@@@@@#+@@@@@@@@:*
*-=@@*@=@@@@@@@@@@#......::::------=+#@@@@@@*+**##%@@@@@#+=----:::.............%@@@@@@@@@:@@@%#@*%:@
 :%@@+%*@@=@@@@-.@-....:::-------=+*@@@@@@@@--=**#%@%@%@@@%*---:::::.............@:.@@@@@%@=%#@@==: 
 :#=@%%%%@+@+.@..:@..:---------+*#@@@%@@@@@@=---@=:@%@%%@@@#+-------:::::.......#%..%#:@+@@+%=@@%:= 
 =-*@@+%=@@.-.%*..*@--------=+*%@@@@%%+@@@@@+=@=@%.@+@%%@@@@@+=-------:::::....-@...@::-#@#@%@@+#:# 
  :#+@%@%@@%...@-..*@---=+*##@@@@%%%###-@@@@*+**%@=-%@%%@@@@@@#+==-----------:=@...@*..:@@*@=@@#:-  
  =:%@@-@.@@+..:@:...@+*#%@@@@@@@@*##%*=:@@@*+*@@@.+%@%%@@@%@%%@@*+=-------:-%@...%%...@@#@#@@=*:%  
   -==@@*@=@@-...@=...#@@@@@@@%@@@@*#*+==:@@*++%@@+=%@%%@@*###%%%@@@%##*+++*@:..:@%...@@+@@%@#@:+   
    :*=@@%%+@@-...@@----=@@@@@#@%@@@%=%-%=:@@%#*@%++@@*%@==@###@@@@%@@@@@@%.-::=@=.:.@@+@@+@%%:-    
     :%+@@%%*@@*:-..@@##%%@@@@@%@*@@@@-+*==:@@#*@%++@@@@-+-%+-@@@%@#@%@@@@%##*@@::-.@@=@%+@@%::     
      :%=@@*%%%@@:==:.@@@@@@@#@*@+@=@@@:-+=-:@-=@@==+%@-=+==+@@@*@%@%@@@@@@@@#:-==*@@+%%#@@%::      
       :#-@@=@%=@@****+=:%@@@@@%@*%@:*%@%++=+-@@@**@@@-++==@@.*%=@+@#@@@@@+:+**+.@@%@%%@@%@::       
        :-+@@#@@@#@@-%@@*@@@@@-*%@-@@-@=@@:+++-@@@@@@-++*:@@%@#@@#@:@+@@@@#%@@-@@@=@@=@@=@::        
         ::@*@%%*%#%@@**@@@@@%@@@+%@*#:%@@@-**++@@@@:**+#@@@::--@*@@@@@@@@@%-@@@-@-+#@@=*:*         
          #:**#::@+@%%@@@-@@@@@@@*%:@%:%@+@@%+*%#@@:++=@@#@@:=@**=@@@@@@@#+@@@=@-@#==-@::@          
            ::@-@@*@.+*@@@@@:@@@@*@@@::@+@@#@@#@@@.**+@@%@*@@.#@@#@@@@*+@@@@-*@@.@@%%-:*            
             -:-@=@@*==@@@.%@@@=+@@@@-:-@@.-@@@@@-**@@@#:#@@+:%@@@%-%@@%-*@@%=-@@@**:-@             
               =::@-@@@@%.+=@.@@@@@*-%@@@*=:@@@@#@%@@@@#:@=@@%==@@@@@%.@@.@@@@@%*#::@               
                 *::@=@@%@@..@@-:..#@@@@@%+::=*#%%%%*+-:-#@@@@@@%.+-.@@.@@+@@-@=::@                 
                    ::=@=%@%%@*.=.@@@*..:@*%@@@@@@@@@@@@%@@@@@@@.%@@-*@@@@**%::*                    
                      #::-@-#@@*..@@@#.@@@@=*@@@::+@@*=@=*@@@@@@@-.:@@@=#%:::@                      
                         #:::*@=+@@@@-#@@@@.%@@+.+.%@%:@%.+:@@@@@@@-#@=::-%                         
                            @*-::-%@+=*%@@@@@@@+@@@*%@@@@@@@%*=#@#-::-#                             
                                 @*:::::=#@@@%*+====*#@@@@#-:::::#@                                 
                                       @@%*=-::::::::::-+*%@@                                                                          


                  /$$   /$$             /$$  /$$$$$$$$        /$$ /$$                    
                  | $$$ | $$            | $$ |__  $$__/       |__/| $$                    
                  | $$$$| $$  /$$$$$$  /$$$$$$  | $$  /$$$$$$  /$$| $$  /$$$$$$   /$$$$$$ 
                  | $$ $$ $$ /$$__  $$|_  $$_/  | $$ |____  $$| $$| $$ /$$__  $$ /$$__  $$
                  | $$  $$$$| $$$$$$$$  | $$    | $$  /$$$$$$$| $$| $$| $$  \ $$| $$  \__/
                  | $$\  $$$| $$_____/  | $$ /$$| $$ /$$__  $$| $$| $$| $$  | $$| $$      
                  | $$ \  $$|  $$$$$$$  |  $$$$/| $$|  $$$$$$$| $$| $$|  $$$$$$/| $$      
                  |__/  \__/ \_______/   \___/  |__/ \_______/|__/|__/ \______/ |__/      

                          A project created and written by Collin Pendleton
                                    cpendleton@3rtnetworks.com
                                            3rt Networks


EOF
# Creating cache directory
mkdir -p /nettailor/cache
mkdir -p /opt/nettailor/backups
mkdir -p /opt/nettailor/downloads
mkdir -p /opt/nettailor/certs

openssl req -x509 -nodes -newkey rsa:4096 -keyout /opt/nettailor/certs/key.pem -out /opt/nettailor/certs/cert.pem -days 365 -subj "/C=US/ST=NY/L=NewYork/O=nettailor/CN=$HOSTNAME"
echo "127.0.0.1 $HOSTNAME" >> /etc/hosts
echo "Hosts file written and can be seen below:"
cat /etc/hosts

# Database Setup
if [[ $DB_TYPE == "postgresql" ]]; then
/wait-for-it.sh "${DB_HOST}:${DB_PORT}" --timeout=60 --strict -- python3 /nettailor/startup/setuppostgresdatabase.py
else
/wait-for-it.sh "${DB_HOST}:${DB_PORT}" --timeout=60 --strict -- python3 /nettailor/startup/setupdatabase.py
fi
echo "Database setup complete"
# Periodic refresh
echo "*/30 * * * * /nettailor/startup/call_refresh_endpoint.sh >/dev/null 2>&1" | crontab -
echo "Cron job added"
# Fix permissions on exim email server folders
mkdir -p /var/log/exim4
mkdir -p /var/spool/exim4
chown -R Debian-exim:Debian-exim /var/log/exim4
chown -R Debian-exim:Debian-exim /var/spool/exim4
echo "Exim permissions fixed"
# Start all services with supervisord
echo $DEBUG_MODE
if [[ $DEBUG_MODE == "true" ]]; then
supervisord -c /nettailor/startup/supervisordebug.conf
else
supervisord -c /nettailor/startup/supervisord.conf
fi
# Create Admin User
# python3 /nettailor/create_user.py $DB_USER $DB_PASSWORD $DB_HOST $DB_NAME $DB_PORT "$FULLNAME" "$USERNAME" $EMAIL $PASSWORD
